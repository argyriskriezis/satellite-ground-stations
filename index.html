<!DOCTYPE html>
<html>
<head>
    <title>Ground Station Map</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Ensures map takes up most of the screen while leaving room for filters */
        #map { height: 85vh; width: 100%; }
        
        .filter { 
            margin: 10px; 
            padding: 10px; 
            font-family: sans-serif;
            border-bottom: 1px solid #ccc;
            background-color: #fcfcfc;
        }

        .company-filter-group {
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
            margin-top: 8px;
        }

        /* Makes labels easier to click */
        label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>

<div class="filter">
    <strong>Filter by Company:</strong>
    <div id="company-filter-group" class="company-filter-group">
        <label><input type="checkbox" id="select-all" checked> <b>(Select All)</b></label>
        </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

// 1. Color Configuration
const companyColors = {
    "Atlas": "#3388ff",
    "Atlas Partner": "#9c27b0",
    "SSC": "#ff5722",
    "SSC Partner": "#ff9800",
    "Leaf": "#4caf50",
    "KSAT": "#e91e63",
    "KSAT Partner": "#607d8b",
    "default": "#000000"
};

function getColor(company) {
    return companyColors[company] || companyColors['default'];
}

// 2. Initialize Map
var map = L.map('map').setView([20, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var stationLayer = L.layerGroup().addTo(map);
var stationsData; 

// 3. Popup Logic
function createPopup(properties) {
    var locationName = properties.station || properties.city || "Unknown Location";
    var html = `<b>Location:</b> ${locationName}, ${properties.country}<br>`;
    html += `<b>Company:</b> ${properties.company}<br>`;
    html += `<b>Status:</b> ${properties.status || 'Unknown'}<br>`;

    var freqs = [];
    if(properties.S_band_Tx || properties.S_band_Rx) freqs.push("S-band");
    if(properties.X_band_Rx) freqs.push("X-band");
    if(properties.Ka_band_Rx) freqs.push("Ka-band");
    if(properties.UHF_Tx || properties.UHF_Rx) freqs.push("UHF");

    if(freqs.length > 0) html += `<b>Frequencies:</b> ${freqs.join(', ')}`;
    return html;
}

// 4. Update Markers based on an ARRAY of selected names
function updateMarkers(selectedCompanies) {
    stationLayer.clearLayers();
    if (!stationsData) return;

    stationsData.features.forEach(function(f) {
        if (selectedCompanies.includes(f.properties.company)) {
            var marker = L.circleMarker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                radius: 8,
                fillColor: getColor(f.properties.company),
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            });
            marker.bindPopup(createPopup(f.properties));
            marker.addTo(stationLayer);
        }
    });
}

// 5. Helper to see what is checked right now
function getSelectedCompanies() {
    const checkboxes = document.querySelectorAll('.company-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// 6. Build the checkbox UI dynamically
function populateCompanyFilter(data) {
    const container = document.getElementById("company-filter-group");
    const companies = new Set();
    data.features.forEach(f => { if (f.properties.company) companies.add(f.properties.company); });

    Array.from(companies).sort().forEach(company => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" class="company-checkbox" value="${company}" checked> ${company}`;
        
        label.querySelector('input').addEventListener('change', () => {
            updateMarkers(getSelectedCompanies());
        });
        container.appendChild(label);
    });

    // Select All / Deselect All logic
    document.getElementById('select-all').addEventListener('change', function() {
        document.querySelectorAll('.company-checkbox').forEach(cb => cb.checked = this.checked);
        updateMarkers(getSelectedCompanies());
    });
}

// 7. Legend
var legend = L.control({position: 'bottomright'});
legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend');
    div.style.background = 'white';
    div.style.padding = '10px';
    div.style.lineHeight = '18px';
    div.style.borderRadius = '5px';
    div.style.boxShadow = '0 0 15px rgba(0,0,0,0.2)';
    div.innerHTML = '<b>Companies</b><br>';
    for (var key in companyColors) {
        if (key !== 'default') {
            div.innerHTML += '<i style="background:' + companyColors[key] + '; width: 12px; height: 12px; display: inline-block; margin-right: 8px;"></i> ' + key + '<br>';
        }
    }
    return div;
};
legend.addTo(map);

// 8. Fetch Data and Start
fetch('stations.geojson')
    .then(response => {
        if (!response.ok) throw new Error("Could not load stations.geojson");
        return response.json();
    })
    .then(data => {
        stationsData = data;
        populateCompanyFilter(data); 
        updateMarkers(getSelectedCompanies()); 
    })
    .catch(error => console.error('Error:', error));

</script>

</body>
</html>
